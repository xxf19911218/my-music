<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevents pull-to-refresh on mobile when scrolling playlist */
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e7ff; /* Indigo-100 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #6366f1; /* Indigo-500 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4f46e5; /* Indigo-600 */
        }
        .song-item.active {
            background-color: #e0f2fe; /* Sky-100 */
            color: #0369a1; /* Sky-700 */
            font-weight: 500;
        }
        .loader {
            border: 4px solid #e0f2fe; /* Sky-100 */
            border-top: 4px solid #0ea5e9; /* Sky-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Initially hidden */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #albumArt {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        #albumArtDefaultContainer {
            background-color: #e0e7ff; 
        }

        /* 音符容器和音符样式 */
        #notesContainer {
            opacity: 0; /* Initially hidden, controlled by JS */
            visibility: hidden; /* Initially hidden */
            transition: opacity 0.3s ease, left 0.1s linear, visibility 0.3s ease; /* Smooth transitions */
            z-index: 10; /* Ensure notes are above the progress bar */
        }

        .music-note-icon {
            font-size: 14px; /* 音符大小调整为更小 */
            margin: 0 1.5px;  /* 音符间距调整 */
            animation-name: jump;
            animation-duration: 0.9s; /* 动画持续时间微调 */
            animation-timing-function: ease-in-out;
            animation-iteration-count: infinite;
            transform-origin: bottom; /* 从底部开始动画 */
            display: inline-block;
        }

        @keyframes jump {
            0%, 100% {
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 0.6;
            }
            25% {
                transform: translateY(-8px) scale(1.05) rotate(-7deg); /* 跳跃高度和旋转调整 */
                opacity: 0.8;
            }
            50% {
                transform: translateY(-15px) scale(1.15) rotate(0deg); /* 跳得更高，缩放调整 */
                opacity: 1;
            }
            75% {
                transform: translateY(-8px) scale(1.05) rotate(7deg); /* 跳跃高度和旋转调整 */
                opacity: 0.8;
            }
        }

        /* 4个音符的颜色和动画延迟 */
        .music-note-icon:nth-child(1) { color: #3b82f6; animation-delay: 0s; }    /* Tailwind blue-500 */
        .music-note-icon:nth-child(2) { color: #ef4444; animation-delay: 0.2s; } /* Tailwind red-500 */
        .music-note-icon:nth-child(3) { color: #22c55e; animation-delay: 0.4s; }  /* Tailwind green-500 */
        .music-note-icon:nth-child(4) { color: #eab308; animation-delay: 0.6s; } /* Tailwind yellow-500 */

    </style>
</head>
<body class="bg-gradient-to-br from-sky-200 to-indigo-300 text-slate-800 flex flex-col items-center justify-center min-h-screen p-4 selection:bg-sky-500 selection:text-white">

    <div class="bg-white/70 backdrop-blur-lg shadow-2xl rounded-2xl w-full max-w-sm overflow-hidden">
        <audio id="audioPlayer" class="hidden"></audio>

        <div class="p-6 space-y-4">
            <div class="aspect-square rounded-lg shadow-lg overflow-hidden">
                <div id="albumArtDefaultContainer" class="w-full h-full flex items-center justify-center bg-slate-200">
                    <i class="fas fa-music text-slate-400 text-6xl"></i>
                </div>
                <img id="albumArt" src="" alt="专辑封面" class="w-full h-full object-cover hidden">
            </div>
            <div>
                <h2 id="songTitle" class="text-2xl font-semibold text-center truncate text-slate-700" title="歌曲名称">歌曲名称</h2>
            </div>
        </div>

        <div class="px-6 space-y-2 relative">
            <div id="notesContainer" class="absolute pointer-events-none flex items-end" style="height: 30px; bottom: 26px;"> {/* 高度和底部位置微调 */}
                {/* 音符将由 JavaScript 在此创建 */}
            </div>
            <input type="range" id="progressBar" value="0" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-sky-500">
            <div class="flex justify-between text-xs text-slate-500">
                <span id="currentTime">0:00</span>
                <span id="totalDuration">0:00</span>
            </div>
        </div>

        <div class="flex items-center justify-around p-6">
            <button id="prevBtn" class="text-slate-500 hover:text-sky-500 transition-colors p-3 rounded-full hover:bg-sky-100/50">
                <i class="fas fa-backward-step fa-lg"></i>
            </button>
            <button id="playPauseBtn" class="text-white bg-sky-500 hover:bg-sky-600 transition-colors w-16 h-16 rounded-full flex items-center justify-center shadow-lg">
                <i class="fas fa-play fa-xl"></i>
            </button>
            <button id="nextBtn" class="text-slate-500 hover:text-sky-500 transition-colors p-3 rounded-full hover:bg-sky-100/50">
                <i class="fas fa-forward-step fa-lg"></i>
            </button>
        </div>
        
        <div class="px-6 pb-6 flex items-center space-x-3">
            <i class="fas fa-volume-down text-slate-500"></i>
            <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-sky-500">
            <i class="fas fa-volume-up text-slate-500"></i>
        </div>

        <div class="border-t border-slate-300/70 p-3">
            <h3 class="text-sm font-medium text-center text-sky-600">播放列表</h3>
        </div>
        
        <div id="playlistContainer" class="h-40 overflow-y-auto bg-white/30">
            {/* 播放列表项将由 JavaScript 在此创建 */}
        </div>
         <div class="flex justify-center py-3">
            <div id="loadingIndicator" class="loader"></div>
        </div>
    </div>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const albumArtDefaultContainer = document.getElementById('albumArtDefaultContainer');
        const albumArt = document.getElementById('albumArt');
        const songTitle = document.getElementById('songTitle');
        const progressBar = document.getElementById('progressBar');
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalDurationDisplay = document.getElementById('totalDuration');
        const prevBtn = document.getElementById('prevBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playPauseIcon = playPauseBtn.querySelector('i');
        const nextBtn = document.getElementById('nextBtn');
        const volumeControl = document.getElementById('volumeControl');
        const playlistContainer = document.getElementById('playlistContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const notesContainer = document.getElementById('notesContainer'); // 获取音符容器

        // --- 歌曲数据 ---
        // artist property removed.
        // albumArt: Provide a URL for actual art, or empty string / "NO_ART" to use default icon.
        const songs = [
            { title: "FreeLoop", src: "./music/Free_Loop.mp3", albumArt: "" },
            { title: "ThatGirl", src: "./music/That_Girl.mp3", albumArt: "" },
            { title: "思念是一种病", src: "./music/思念是一种病.mp3", albumArt: "" },
            { title: "一生有你", src: "./music/一生有你-水木年华.mp3", albumArt: "" },
            { title: "下雨天", src: "./music/下雨天-南拳妈妈.mp3", albumArt: "" },
            { title: "世界が終るまでは", src: "./music/世界が終るまでは.mp3", albumArt: "" },
            { title: "光阴的故事", src: "./music/光阴的故事-罗大佑.mp3", albumArt: "" },
            { title: "凤凰花开的路口", src: "./music/凤凰花开的路口-胡夏.mp3", albumArt: "" },
            { title: "原来你也在这里", src: "./music/原来你也在这里-刘若英.mp3", albumArt: "" },
            { title: "和你一样", src: "./music/和你一样-李宇春.mp3", albumArt: "" },
            { title: "夜空中最亮的星", src: "./music/夜空中最亮的星-逃跑计划.mp3", albumArt: "" },
            { title: "往后余生", src: "./music/往后余生-王贰浪.mp3", albumArt: "" },
            { title: "忽然之间", src: "./music/忽然之间-莫文蔚.mp3", albumArt: "" },
            { title: "怎样", src: "./music/怎样-戴佩妮.mp3", albumArt: "" },
            { title: "成都", src: "./music/成都-赵雷.mp3", albumArt: "" },
            { title: "我很快乐", src: "./music/我很快乐-刘惜君.mp3", albumArt: "" },
            { title: "无地自容", src: "./music/无地自容-黑豹乐队.mp3", albumArt: "" },
            { title: "没那么简单", src: "./music/没那么简单-黄小琥.mp3", albumArt: "" },
            { title: "爱 很简单", src: "./music/爱 很简单-陶喆.mp3", albumArt: "" },
            { title: "白天不懂夜的黑", src: "./music/白天不懂夜的黑-那英.mp3", albumArt: "" },
            { title: "百年孤寂", src: "./music/百年孤寂-王菲.mp3", albumArt: "" },
            { title: "直到世界尽头", src: "./music/直到世界尽头.mp3", albumArt: "" },
            { title: "空空如也", src: "./music/空空如也-任然.mp3", albumArt: "" },
            { title: "说散就散", src: "./music/说散就散-袁娅维.mp3", albumArt: "" },
            { title: "起风了", src: "./music/起风了-买辣椒也用券.mp3", albumArt: "" },
            { title: "路过人间", src: "./music/路过人间-郁可唯.mp3", albumArt: "" },
            { title: "遇见", src: "./music/遇见-孙燕姿.mp3", albumArt: "" },
            { title: "遥远的你", src: "./music/遥远的你-不靠谱组合.mp3", albumArt: "" }
        ];

        let currentSongIndex = 0;
        let isPlaying = false;

        // 创建音符元素
        function createMusicalNotes() {
            const numNotes = 4; // 创建4个音符
            notesContainer.innerHTML = ''; // 清空旧音符（如果需要重新创建）
            for (let i = 0; i < numNotes; i++) {
                const noteEl = document.createElement('i');
                noteEl.classList.add('fas', 'fa-music', 'music-note-icon');
                // CSS :nth-child 会处理颜色和动画延迟
                notesContainer.appendChild(noteEl);
            }
        }

        // 更新音符位置和可见性
        function updateNotesPosition() {
            if (!audioPlayer.duration || audioPlayer.duration <= 0) {
                notesContainer.style.opacity = '0';
                notesContainer.style.visibility = 'hidden';
                return;
            }

            if (isPlaying) {
                notesContainer.style.opacity = '1';
                notesContainer.style.visibility = 'visible';
            } else {
                notesContainer.style.opacity = '0';
                notesContainer.style.visibility = 'hidden';
            }

            const progressPercent = (progressBar.value / progressBar.max);
            const progressBarWidth = progressBar.offsetWidth;
            const notesContainerWidth = notesContainer.offsetWidth;

            let thumbCenterRelativeToProgressBarStart = progressPercent * progressBarWidth;
            let newLeft = thumbCenterRelativeToProgressBarStart - (notesContainerWidth / 2);

            // 限制音符容器在进度条范围内
            newLeft = Math.max(0, Math.min(newLeft, progressBarWidth - notesContainerWidth));
            
            notesContainer.style.left = `${newLeft}px`;
        }


        function loadSong(songIndex) {
            if (songIndex < 0 || songIndex >= songs.length) return;
            
            loadingIndicator.style.display = 'block'; // 显示加载指示器
            albumArt.classList.add('hidden'); // 隐藏旧封面
            albumArtDefaultContainer.classList.remove('hidden'); // 显示默认图标

            const song = songs[songIndex];
            currentSongIndex = songIndex;
            
            songTitle.textContent = song.title;
            songTitle.title = song.title; 

            if (song.albumArt && song.albumArt.trim() !== "" && song.albumArt !== "NO_ART") {
                albumArt.src = song.albumArt;
                albumArt.onload = () => { // 确保图片加载后再显示
                    albumArt.classList.remove('hidden');
                    albumArtDefaultContainer.classList.add('hidden');
                }
                albumArt.onerror = () => { // 图片加载失败处理
                    albumArt.classList.add('hidden');
                    albumArtDefaultContainer.classList.remove('hidden');
                     console.warn("Album art failed to load: " + song.albumArt);
                }
            } else {
                albumArt.src = ""; 
                albumArt.classList.add('hidden');
                albumArtDefaultContainer.classList.remove('hidden');
            }
            
            audioPlayer.src = song.src;
            updatePlaylistHighlight();

            audioPlayer.onloadedmetadata = () => {
                totalDurationDisplay.textContent = formatTime(audioPlayer.duration);
                progressBar.max = audioPlayer.duration;
                progressBar.value = 0; // 重置进度条
                currentTimeDisplay.textContent = formatTime(0);
                loadingIndicator.style.display = 'none'; 
                updateNotesPosition(); // 更新音符初始位置和状态
                if (isPlaying) { 
                    playSong(); // 如果之前是播放状态，则自动播放新歌
                }
            };
            audioPlayer.onerror = () => {
                loadingIndicator.style.display = 'none';
                // 避免覆盖整个播放列表，可以在特定区域显示错误
                const errorMsg = document.createElement('p');
                errorMsg.className = 'text-red-500 p-2 text-center text-xs';
                errorMsg.textContent = `错误: 无法加载歌曲 "${song.title}"`;
                // 简单地在播放列表顶部插入错误
                if(playlistContainer.firstChild && playlistContainer.firstChild.textContent.startsWith("错误:")) {
                    playlistContainer.firstChild.remove(); // 移除旧的错误信息
                }
                playlistContainer.insertBefore(errorMsg, playlistContainer.firstChild);
                setTimeout(() => { if(errorMsg.parentNode) errorMsg.remove() }, 5000);
                console.error("Error loading song: " + song.src);
                // 尝试播放下一首，或者停止
                if (songs.length > 1) { 
                    // nextSong(); // 自动跳到下一首可能会导致循环错误，用户手动操作更好
                } else {
                    pauseSong(); // 停止播放
                    songTitle.textContent = "加载失败";
                }
            }
        }

        function playSong() {
            isPlaying = true;
            // 确保 audioPlayer.play() 返回的是 Promise
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    // 播放成功
                    playPauseIcon.classList.remove('fa-play');
                    playPauseIcon.classList.add('fa-pause');
                })
                .catch(error => {
                    console.error("播放错误:", error);
                    isPlaying = false; 
                    playPauseIcon.classList.remove('fa-pause');
                    playPauseIcon.classList.add('fa-play');
                    // 界面提示用户播放失败
                    const errorMsg = document.createElement('p');
                    errorMsg.className = 'text-red-500 p-2 text-center text-xs absolute top-0 left-1/2 -translate-x-1/2 bg-white/80 rounded-md shadow-lg';
                    errorMsg.textContent = `播放失败: 请检查音频文件或网络。`;
                    document.body.appendChild(errorMsg); // 添加到body，使其在最上层
                    setTimeout(() => { if(errorMsg.parentNode) errorMsg.remove() }, 3000);
                });
            }
            updateNotesPosition(); // 更新音符状态
        }

        function pauseSong() {
            isPlaying = false;
            audioPlayer.pause();
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            updateNotesPosition(); // 更新音符状态
        }

        function togglePlayPause() {
            if (audioPlayer.src && audioPlayer.src !== window.location.href) { // 检查是否有有效歌曲源
                 if (isPlaying) {
                    pauseSong();
                } else {
                    playSong();
                }
            } else if (songs.length > 0) { // 如果没有有效源但列表有歌，尝试加载第一首
                loadSong(currentSongIndex); 
            }
        }

        function prevSong() {
            currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            loadSong(currentSongIndex);
        }

        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % songs.length;
            loadSong(currentSongIndex);
        }

        function updateProgress() {
            if (audioPlayer.duration) {
                progressBar.value = audioPlayer.currentTime;
                currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
                updateNotesPosition(); // 实时更新音符位置
            }
        }

        function setProgress(e) {
            if(audioPlayer.duration) { // 只有在歌曲加载完毕后才允许拖动
                 audioPlayer.currentTime = e.target.value;
                 updateNotesPosition(); // 更新音符位置
            }
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function setVolume(e) {
            audioPlayer.volume = e.target.value;
        }

        function renderPlaylist() {
            playlistContainer.innerHTML = '';
            if (songs.length === 0) {
                playlistContainer.innerHTML = '<p class="text-slate-500 p-4 text-center">播放列表为空。</p>';
                return;
            }
            songs.forEach((song, index) => {
                const div = document.createElement('div');
                div.classList.add('song-item', 'p-3', 'hover:bg-sky-50', 'cursor-pointer', 'border-b', 'border-slate-200/80', 'text-sm', 'transition-colors', 'truncate');
                div.textContent = song.title;
                div.title = song.title; 
                
                div.addEventListener('click', () => {
                    if (currentSongIndex !== index || !isPlaying) {
                        isPlaying = true; 
                        loadSong(index);
                    }
                });
                playlistContainer.appendChild(div);
            });
            updatePlaylistHighlight();
        }
        
        function updatePlaylistHighlight() {
            const songItems = playlistContainer.querySelectorAll('.song-item');
            songItems.forEach((item, index) => {
                if (index === currentSongIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // 事件监听器
        playPauseBtn.addEventListener('click', togglePlayPause);
        prevBtn.addEventListener('click', prevSong);
        nextBtn.addEventListener('click', nextSong);
        audioPlayer.addEventListener('timeupdate', updateProgress);
        audioPlayer.addEventListener('ended', nextSong); 
        progressBar.addEventListener('input', setProgress); 
        volumeControl.addEventListener('input', setVolume);
        
        // 初始加载
        window.addEventListener('load', () => {
            createMusicalNotes(); // 创建音符DOM元素
            if (songs.length > 0) {
                loadSong(currentSongIndex); 
            } else {
                songTitle.textContent = "播放列表为空";
                totalDurationDisplay.textContent = "0:00";
                loadingIndicator.style.display = 'none';
                updateNotesPosition(); 
            }
            renderPlaylist();
            audioPlayer.volume = parseFloat(volumeControl.value); 
        });

        window.addEventListener('resize', () => {
            if (audioPlayer.readyState > 0) { 
                 updateNotesPosition();
            }
        });

    </script>
</body>
</html>
